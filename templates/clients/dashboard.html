{% extends 'nodes/base.html' %}

{% load staticfiles %}
{% load i18n %}
{% load humanize %}
{% load custom_tags %}

{% block extracss %}
<link rel="stylesheet" type="text/css" href="{% static "css/dashboard.css" %}">
{% endblock %}

{% block title %} {% trans "Dashboard" %}: {% trans "Vizipedia - the interactive encyclopedia" %} {% endblock %}


{% block article_main %}

  {% if profile %}
    <div class="dashboard-cover" style="background-image:url('{{ media_url }}{{ profile.cover_picture}}')">&nbsp;
    </div>
    <div class="dashboard-profile">

      {% if profile_form %}
        <form method="POST" id="profile_form" class="clearfix" enctype="multipart/form-data" name="profile_form" action="{% url 'clients_dashboard' %}">
          <div id="profile-close-but"><i class="fas fa-times"></i></div>
          {% csrf_token %}
          {% for field in profile_form %}
            {% if field.field.widget.input_type == "file" %}
              <div class="input-group-file">
            {% else %}
              <div class="input-group input-group-{{field.name}}">
            {% endif %}
                <label class="flabel">
                  {% if field.field.required %} <span class="req">*</span> {% endif %}
                  {% trans field.label %}:
                </label><br>
                {{ field }}
                <ul class="errorlist">
                  {% for error in field.errors %}
                  <li>{{ error }}</li>
                  {% endfor %}
                </ul>
              </div>
          {% endfor %}
          <div class="div-avatar"><img id="avatarimg" src="{{ media_url }}{{ profile.picture }}" onerror="this.src='/static/img/default-avatar.png'" /></div>
          <div id="cropper"></div>
          <input type="submit" id="profile_form_submit" value="{% trans "Save" %}">
          <div id="profile-form-loader"></div>
        </form>
      {% endif %}

      <div id="profile-static">
        <div id="profile-edit-but"><i class="fas fa-edit"></i></div>
        <span class="dashboard-profile-picture" style="background-image:url('{{ media_url }}{{ profile.picture }}')"></span>
        <h1 class="dashboard-profile-name">{{profile.name}}</h1>
        <h2 class="dashboard-profile-info">{{profile.city}}, {{profile.country}} <br> <a href="{{profile.website}}" target="_blank">{{profile.website}}</a> </h2>
        <h3 class="dashboard-profile-membersince">{% trans "Member since: " %}{{user.date_joined|naturaltime}}</h3>
        <!-- <h4>{% trans "Balance: " %} ${{balance}}</h4> -->
        <h4>{% trans "Plan: " %}</h4>
        {% for subsc in subscriptions %}
          <h5>{{subsc.offering.name}}</h5>
          <div class='dashboard-profile-membersince'>
            {% for key, val in subsc.perks_tracker.items %}
            {{key|underscore_to_space}}: {{val}}<br>
            {% endfor %}
          </div>
        {% endfor %}
        {% if not subscriptions %}
            <h5>{% trans "None " %}</h5>
            <br><a class="btn-standard btn-standard-round" href="{% url 'client_plans' %}">Add Plan</a>
        {% else %}
          <br><a class="btn-standard btn-standard-round" href="{% url 'client_plans' %}">Upgrade Plan</a>
        {% endif %}
      </div>

    </div>

    <div class="main-container dashboard">

        <a href="{% url 'creator_new' %}" class="dashboard-node-add">{% trans "Create new project" %}</a>

        <section class="dashboard-nodes clearfix">
          <div class="clearfix">
            <h2 class="dashboard-nodes-title dashboard-section-title"> {% trans "My projects:" %} </h2>
            <form class="dashboard-nodes-filter" id="filter-form" method="GET" class="clearfix">
              {% csrf_token %}
              <label class="switch">
                <input type="checkbox" id="switch-show-embedded" name="show_embedded" {% if show_embedded %}checked="true"{% endif %}>
                <span class="slider round"></span>
              </label>
              <span class="switch-label">{% trans "Show embedded:" %}</span>
            </form>
          </div>

          {% if nodes %}

          {% for node in nodes %}

          <div class="node-link" href="{% url 'nodes_detail' slug=node.slug %}">
          <div class="node" id="{{node.slug}}">

            <div class="node-image-container">
              <div class="node-image" style="background-image:url('{% if node.thumbnail1 %}{{ media_url }}{{ node.thumbnail1}}{% else %}{% static "img/icons/thmb-default-" %}{{node.engine}}.png{% endif %}')" data-thumbnails="{% if node.thumbnail1 %}{{ media_url }}{{ node.thumbnail1}}{% else %}{% static "img/icons/thmb-default-" %}{{node.engine}}.png{% endif %},{% if node.thumbnail2 %}{{ media_url }}{{ node.thumbnail2}}{% else %}{% static "img/icons/thmb-default-" %}{{node.engine}}.png{% endif %},{% if node.thumbnail3 %}{{ media_url }}{{ node.thumbnail3}}{% else %}{% static "img/icons/thmb-default-" %}{{node.engine}}.png{% endif %},{% if node.thumbnail4 %}{{ media_url }}{{ node.thumbnail4}}{% else %}{% static "img/icons/thmb-default-" %}{{node.engine}}.png{% endif %}">
              </div>
            </div>

            <div class="controlbar">
              <div class="playstopbutton-container">
                <div class="playstopbutton-back">
                  <svg viewBox="0 0 120 32" preserveAspectRatio="xMinYMin meet">
                     <path  d="M102,22.8C91.6,12.4,81.2,1,63.5,0.8l0,0c-0.1,0-0.2,0-0.2,0c-0.1,0-0.2,0-0.2,0l0,0C45.3,1,35,12.4,24.5,22.8c-9,9-25,9-25,9H61h1.5H127C127,31.8,111,31.8,102,22.8z" style="stroke: none; fill:white;"></path>
                    </svg>
                </div>
                <div class="nodetypebutton nodetypebutton-{% if node.engine == 'explot' %}{% if node.interactivity > 1 %}intpiece{% else %}video{% endif %}{% elif node.engine == 'game_matching' or node.engine == 'game_mapconv' or node.engine == 'game_pointnclick' or node.engine == 'game_multchoice' or node.engine == 'game_occupation' or node.engine == 'game_endlessrunner' or node.engine == 'game_fallingcategoriser' %}game{% endif %}">&nbsp;</div>
              </div>

              <div class="action-buttons">
                <ul class="action-buttons-items">
                  <li class="action-buttons-first"><i class="fas fa-eye"></i> {{node.views}}</li>
                  <li><i class="fas fa-heart"></i> {{node.likes}}</li>
                  <li><i class="fas fa-share-alt"></i> {{node.shares}}</li>
                </ul>
              </div>

              <div class="metadata">
                <h2 class="metadata-title">{{ node.title|truncatewords:9 }}</h2>
                <div class="metadata-embeds">
                  {% if node.embedded_in.all|length > 0 %}
                    <div class="metadata-embed" target="_blank"><i class="fas fa-paperclip"></i>
                      {% trans "Embedded in" %} {{node.embedded_in.all|length}} {% trans "project(s)" %}
                    </div>
                    <div class="metadata-embed-all">
                      <div>{% trans "This project is embedded in:" %}</div>
                    {% for emb_in in node.embedded_in.all %}
                      <a class="metadata-embed-one" href="{% url 'nodes_detail' slug=emb_in.slug %}" target="_blank"><i class="fas fa-paperclip"></i> {{emb_in.title|truncatewords:9}}</a>
                    {% endfor %}
                    </div>
                  {% endif %}
                </div>
                <div class="metadata-extra">

                  <div class="metadata-extra-date">{{node.created_at|naturaltime}}</div>
                  <div class="metadata-extra-menu clerfix">
                    <div class="metadata-extra-menu-button node-menu-button" data-id="{{node.pk}}">&nbsp;</div>
                    <ul class="metadata-extra-menu-menu node-menu-block" id="node-menu-block{{node.pk}}" style="display: none;">
                      <li class="node-menu-preview" data-url="{% url 'nodes_detail' slug=node.slug %}" target="_blank"><i class="fas fa-eye"></i> {% trans "Preview" %}</li>
                      <li class="node-menu-update" data-url="{% url 'editor_node' node_id=node.pk %}?meta_edit=true"><i class="fas fa-pen"></i> {% trans "Update details" %}</li>
                      <li class="node-menu-stat" data-url="{% url 'dashboard_node' node_id=node.pk %}"><i class="fas fa-columns"></i> {% trans "Statistics" %}</li>
                      <li class="node-menu-edit" data-url="{% url 'editor_node' node_id=node.pk %}"><i class="fas fa-pen"></i> {% trans "Edit project" %}</li>
                      {% if perk_embed_allowed %}
                        <li class="node-menu-embed" data-url="{{node.ifr_url}}"><i class="fas fa-code"></i> {% trans "Embed project" %}</li>
                        {% if node.engine == 'game_pointnclick' %}
                          <li class="node-menu-scorm" data-url="{% url 'create_scorm_export' node_id=node.pk %}"><i class="fas fa-file"></i> {% trans "Get SCORM" %}</li>
                        {% endif %}
                      {% endif %}
                      <li class="node-menu-delete" data-url="{% url 'delete_node' node_id=node.pk %}"><i class="fas fa-trash"></i> {% trans "Delete" %}</li>
                    </ul>
                  </div>
                </div>
              </div>

            </div>
          </div>
        </div>

        {% endfor %}

        {% else %}
        <p class="paragraph-light">You haven't created any projects yet</p>
        {% endif %}
        </section>

    </div>

    <div id="dialog-wrapper" style="display: none;">

      <div id="dialog-del" style="display: none;">
        <div class="dialog-text">
          <p id="dialog-text-deletenode">
            {% trans "Are you sure you want to delete this node? This action cannot be reverted! It will remove all the data related to it! " %}
          </p>
          <p id="dialog-text-deletead" style='display: none;'>
            {% trans "Are you sure you want to delete this add? This action cannot be reverted! It will remove all the data related to it! " %}
          </p>
        </div>
        <div class="dialog-actions">
          <a href="#" class="dialog-action" id="dialog-actions-cancel">{% trans "Cancel" %}</a>
          <a href="#" class="dialog-action" id="dialog-actions-execute">{% trans "Delete" %}</a>
        </div>
      </div>

      {% if perk_embed_allowed %}

      <div id="dialog-ifr" style="display: none;">
        <p>{% trans "Here is your embed code" %}</p>
        <textarea id="dialog-ifr-code" name="name" rows="8"></textarea><br>
        <a href="#" class="dialog-action" id="dialog-actions-ifr-close">{% trans "Close" %}</a>
        <!-- <iframe id="vizipedia-embed-if" title="Vizipedia game" src="{{ifr_url}}" {% if ifr_height %} height="{{ifr_height}}" {% endif %} allow="fullscreen" ></iframe> -->
      </div>

      {% endif %}

    </div>


  {% else %}
    <div class="main-container dashboard">
      <p>{% trans "You don't have a profile" %}</p>
    </div>
  {% endif %}

{% endblock %}

{% block extrajs %}
{% if profile_form %}
{{ profile_form.media }}
{% endif %}
<script src="{% static "js/dashboard.js" %}"></script>
{% endblock %}
